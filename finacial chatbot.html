<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinHelp - Financial Chatbot Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .chat-bubble {
            max-width: 90%; 
            word-wrap: break-word;
            display: flex;
            align-items: center;
        }

        .chat-bubble-user {
            @apply bg-blue-600 text-white ml-auto;
        }

        .chat-bubble-bot {
            @apply bg-gray-100 text-gray-800 mr-auto;
        }
        
        .chat-bubble-content {
            flex: 1;
        }

        #chat-window::-webkit-scrollbar {
            width: 6px;
        }
        #chat-window::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #chat-window::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }
        #chat-window::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        
        #sidebar::-webkit-scrollbar {
            width: 6px;
        }
        #sidebar::-webkit-scrollbar-track {
            background: #f9fafb;
            border-radius: 10px;
        }
        #sidebar::-webkit-scrollbar-thumb {
            background: #e5e7eb;
            border-radius: 10px;
        }
        #sidebar::-webkit-scrollbar-thumb:hover {
            background: #d1d5db;
        }

        .typing-indicator {
            display: inline-flex;
            gap: 3px;
        }
        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: #9ca3af;
            border-radius: 50%;
            animation: typing-bounce 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing-bounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        #mic-button.is-recording {
            @apply bg-red-500 text-white ring-red-300;
        }
        #mic-button.is-recording svg {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .speak-btn {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 28px;
            height: 28px;
            border-radius: 9999px;
            background-color: rgba(0, 0, 0, 0.05);
            margin-left: 8px;
            vertical-align: middle;
            cursor: pointer;
            transition: background-color 0.15s ease-in-out;
            flex-shrink: 0;
        }
        .speak-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
        .speak-btn svg {
            width: 16px;
            height: 16px;
            color: #4b5563;
        }

        .product-card {
            @apply bg-gradient-to-br from-white to-blue-50 border border-blue-100 rounded-xl p-4 shadow-sm;
            transition: all 0.3s ease;
        }
        .product-card:hover {
            @apply shadow-md transform scale-105;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #f00;
            animation: confetti-fall 5s linear forwards;
        }
        @keyframes confetti-fall {
            to { transform: translateY(100vh) rotate(360deg); }
        }

        .retry-btn {
            @apply px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors font-medium text-sm;
        }

        /* UPDATED: Calculator Modal Styles */
        #calculator-modal {
            /* Removed flex items-center justify-center */
            @apply fixed inset-0 bg-gray-900 bg-opacity-50 z-50 transition-opacity;
        }
        /* UPDATED per instruction 1 */
        #calculator-modal-content {
            @apply bg-white rounded-lg shadow-xl overflow-hidden;
            position: fixed; 
            top: 100px; 
            left: 100px; 
            width: 400px; 
            max-width: 90vw;
            z-index: 1000;
            transform: translate3d(0, 0, 0); /* Initial transform for JS drag function */
        }
        /* UPDATED per instruction 5 */
        #calculator-modal-header {
            cursor: move;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            user-select: none; /* Prevent text selection while dragging */
        }
        #calculator-modal-header:active {
            cursor: grabbing;
        }
        .calculator-result {
            @apply mt-4 p-4 bg-gray-100 rounded-lg text-center;
        }
        .calculator-result p {
            @apply text-sm text-gray-600 mb-1;
        }
        .calculator-result h4 {
            @apply text-2xl font-bold text-blue-600;
        }

        /* NEW: Force-hide templates */
        [type="text/html-template"] {
            display: none !important; /* Added !important */
        }
    </style>
</head>
<body class="bg-white text-gray-900">
    <div class="flex h-screen w-full">
        
        <!-- Sidebar -->
        <div id="sidebar" class="w-80 flex-shrink-0 bg-gray-50 border-r border-gray-200 p-6 flex flex-col gap-6 overflow-y-auto">
            <h1 class="text-2xl font-bold text-gray-800" data-i18n="sidebarTitle">Financial Chatbot</h1>

            <!-- Language Selector -->
            <div id="language-selector" class="flex flex-col items-stretch gap-2">
                <span class="font-medium text-gray-700 text-sm mb-1" data-i18n="langPrompt">Choose Language:</span>
                <button data-lang="en" class="lang-btn px-4 py-2 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 transition-all ring-2 ring-offset-2 ring-transparent focus:ring-blue-500 text-left flex justify-start">
                    English
                </button>
                <button data-lang="hi" class="lang-btn px-4 py-2 rounded-lg font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition-all ring-2 ring-offset-2 ring-transparent focus:ring-gray-400 text-left flex justify-start">
                    ‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)
                </button>
                <button data-lang="or" class="lang-btn px-4 py-2 rounded-lg font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition-all ring-2 ring-offset-2 ring-transparent focus:ring-gray-400 text-left flex justify-start">
                    ‡¨ì‡¨°‡¨º‡¨ø‡¨Ü (Odia)
                </button>
            </div>

            <!-- User Profile -->
            <div class="relative">
                <div id="user-profile" class="hidden border border-gray-200 bg-white rounded-lg p-3 cursor-pointer">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center">
                            <span class="text-lg">üë§</span>
                        </div>
                        <div>
                            <p class="text-xs font-semibold">Risk: <span id="risk-level" class="font-bold">Not set</span></p>
                            <p class="text-xs">Goals: <span id="goals-count" class="font-bold">0</span></p>
                        </div>
                    </div>
                </div>

                <!-- Achievements -->
                <div id="achievements" class="hidden absolute top-full mt-2 left-0 bg-white text-gray-800 rounded-lg shadow-xl p-4 w-64 z-40">
                    <h4 class="font-semibold text-sm mb-2">Your Achievements</h4>
                    <div class="space-y-2">
                        <div id="achieve-goal" class="flex items-center gap-2 opacity-30">
                            <span class="text-lg">üéØ</span>
                            <span class="text-xs">Goal Setter</span>
                        </div>
                        <div id="achieve-risk" class="flex items-center gap-2 opacity-30">
                            <span class="text-lg">‚öñÔ∏è</span>
                            <span class="text-xs">Risk Assessed</span>
                        </div>
                        <div id="achieve-invest" class="flex items-center gap-2 opacity-30">
                            <span class="text-lg">üí°</span>
                            <span class="text-xs">Smart Investor</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Tracker -->
            <div id="progress-tracker" class="hidden bg-blue-50 p-4 border border-blue-200 rounded-lg">
                <div class="flex flex-col items-start gap-3 text-sm">
                    <span class="font-medium text-blue-800">Financial Profile Progress:</span>
                    <div class="flex flex-col gap-2 w-full">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-gray-300 rounded-full step-dot" data-step="goal"></div>
                            <span class="text-xs text-gray-600">Goal</span>
                        </div>
                         <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-gray-300 rounded-full step-dot" data-step="time"></div>
                            <span class="text-xs text-gray-600">Time</span>
                        </div>
                         <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-gray-300 rounded-full step-dot" data-step="risk"></div>
                            <span class="text-xs text-gray-600">Risk</span>
                        </div>
                         <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-gray-300 rounded-full step-dot" data-step="recommendation"></div>
                            <span class="text-xs text-gray-600">Plan</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial Calculators -->
            <div id="tools-section" class="border-t border-gray-200 pt-6">
                <h3 class="font-semibold text-gray-700 mb-3" data-i18n="toolsTitle">Quick Financial Tools</h3>
                <!-- REVERTED: Changed links back to buttons -->
                <div class="grid grid-cols-2 gap-3">
                    <button data-tool="sip" class="tool-btn p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-300 transition-all text-sm flex flex-col items-center gap-1 shadow-sm hover:shadow-md">
                        <span>üí∞</span>
                        <span class="font-medium" data-i18n="tools.sip">SIP Calculator</span>
                    </button>
                    <button data-tool="emi" class="tool-btn p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-300 transition-all text-sm flex flex-col items-center gap-1 shadow-sm hover:shadow-md">
                        <span>üè†</span>
                        <span class="font-medium" data-i18n="tools.emi">EMI Calculator</span>
                    </button>
                    <!-- Checked per instruction 3: data-tool="fd" is correct -->
                    <button data-tool="fd" class="tool-btn p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-300 transition-all text-sm flex flex-col items-center gap-1 shadow-sm hover:shadow-md">
                        <span>üìà</span>
                        <span class="font-medium" data-i18n="tools.fd">FD Returns</span>
                    </button>
                    <button data-tool="goal" class="tool-btn p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-300 transition-all text-sm flex flex-col items-center gap-1 shadow-sm hover:shadow-md">
                        <span>üéØ</span>
                        <span class="font-medium" data-i18n="tools.goal">Goal Planner</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="flex-1 flex flex-col h-screen bg-white relative">
            
            <!-- Session Restore Prompt -->
            <div id="session-prompt" class="hidden absolute top-0 left-0 w-full p-3 bg-yellow-100 text-yellow-900 z-50 shadow">
                <div class="flex justify-between items-center max-w-3xl mx-auto">
                    <p class="text-sm font-medium">Welcome back! Want to continue your last session?</p>
                    <div>
                        <button id="session-yes" class="px-3 py-1 bg-green-600 text-white rounded text-sm font-semibold hover:bg-green-700">Yes, continue</button>
                        <button id="session-no" class="ml-2 px-3 py-1 bg-gray-300 text-gray-800 rounded text-sm hover:bg-gray-400">No, start new</button>
                    </div>
                </div>
            </div>

            <!-- Chat Window -->
            <div id="chat-window" class="flex-1 p-6 overflow-y-auto bg-white">
                <div id="chat-message-list" class="max-w-3xl mx-auto space-y-4">
                    <!-- Chat messages will be appended here -->
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 border-t border-gray-200 bg-white">
                <div class="max-w-3xl mx-auto">
                    <!-- Loading & Error Display -->
                    <div id="status-area" class="p-0 mb-2">
                        <div id="loading-indicator" class="hidden items-center gap-2 text-gray-500">
                            <div class="typing-indicator">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                            <span>FinHelp is typing...</span>
                        </div>
                        <div id="error-message" class="hidden text-red-600 font-medium p-3 bg-red-50 rounded-lg">
                            <!-- Error content will be set by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Input Form -->
                    <form id="chat-form" class="flex items-center relative">
                        <input 
                            type="text" 
                            id="chat-input" 
                            placeholder="Type or speak your message..." 
                            autocomplete="off"
                            class="flex-1 px-5 py-3 pr-24 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                        
                        <!-- Button Wrapper -->
                        <div class="absolute right-2 top-1/2 -translate-y-1/2 flex items-center gap-1">
                            <!-- Voice Input Button -->
                            <button 
                                type="button" 
                                id="mic-button"
                                title="Speak your message"
                                class="p-2.5 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition-all focus:outline-none focus:ring-2 focus:ring-gray-400 disabled:bg-gray-300"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" />
                                <path d="M5.5 8.5A.5.5 0 016 9v1a4 4 0 004 4 4 4 0 004-4V9a.5.5 0 011 0v1a5 5 0 01-4.5 4.975V17h3a.5.5 0 010 1h-7a.5.5 0 010-1h3v-2.025A5 5 0 015 10V9a.5.5 0 01.5-.5z" />
                                </svg>
                            </button>
                            <button 
                                type="submit" 
                                id="send-button"
                                class="p-2.5 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition-all focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-gray-400"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path d="M3.105 2.288a.75.75 0 00-.826.95l1.414 4.925A1.5 1.5 0 005.135 9.25h6.115a.75.75 0 010 1.5H5.135a1.5 1.5 0 00-1.442 1.087l-1.414 4.925a.75.75 0 00.826.95 28.896 28.896 0 0015.293-7.154.75.75 0 000-1.115A28.897 28.897 0 003.105 2.288z" />
                                </svg>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- RE-ADDED: Calculator Modal -->
    <div id="calculator-modal" class="hidden">
        <div id="calculator-modal-content">
            <!-- UPDATED: Header now has ID for dragging -->
            <div id="calculator-modal-header" class="flex justify-between items-center p-4 border-b">
                <h3 id="calculator-modal-title" class="text-lg font-semibold"></h3>
                <button id="calculator-modal-close" class="text-gray-500 hover:text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                        <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                    </svg>
                </button>
            </div>
            <!-- Body -->
            <div id="calculator-modal-body" class="p-6">
                <!-- Calculator content will be injected here -->
            </div>
        </div>
    </div>

    <!-- RE-ADDED: Calculator HTML Templates -->
    <script type="text/html-template" id="sip-calc-template">
        <form id="sip-form" class="space-y-4">
            <div>
                <label for="sip-investment" class="block text-sm font-medium text-gray-700" data-i18n="calculator.sip.investment">Monthly Investment (‚Çπ)</label>
                <input type="number" id="sip-investment" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <div>
                <label for="sip-rate" class="block text-sm font-medium text-gray-700" data-i18n="calculator.sip.rate">Expected Return Rate (% p.a.)</label>
                <input type="number" id="sip-rate" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <div>
                <label for="sip-years" class="block text-sm font-medium text-gray-700" data-i18n="calculator.sip.years">Time Period (Years)</label>
                <input type="number" id="sip-years" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700" data-i18n="calculator.calculate">Calculate</button>
            <div id="sip-result" class="calculator-result hidden"></div>
        </form>
    </script>

    <script type="text/html-template" id="emi-calc-template">
        <form id="emi-form" class="space-y-4">
            <div>
                <label for="emi-amount" class="block text-sm font-medium text-gray-700" data-i18n="calculator.emi.amount">Loan Amount (‚Çπ)</label>
                <input type="number" id="emi-amount" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <div>
                <label for="emi-rate" class="block text-sm font-medium text-gray-700" data-i18n="calculator.emi.rate">Interest Rate (% p.a.)</label>
                <input type="number" id="emi-rate" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <div>
                <label for="emi-months" class="block text-sm font-medium text-gray-700" data-i18n="calculator.emi.months">Loan Tenure (Months)</label>
                <input type="number" id="emi-months" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700" data-i18n="calculator.calculate">Calculate</button>
            <div id="emi-result" class="calculator-result hidden"></div>
        </form>
    </script>

    <script type="text/html-template" id="fd-calc-template">
        <form id="fd-form" class="space-y-4">
            <div>
                <label for="fd-amount" class="block text-sm font-medium text-gray-700" data-i18n="calculator.fd.amount">Total Investment (‚Çπ)</label>
                <input type="number" id="fd-amount" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <div>
                <label for="fd-rate" class="block text-sm font-medium text-gray-700" data-i18n="calculator.fd.rate">Interest Rate (% p.a.)</label>
                <input type="number" id="fd-rate" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <div>
                <label for="fd-years" class="block text-sm font-medium text-gray-700" data-i18n="calculator.fd.years">Time Period (Years)</label>
                <input type="number" id="fd-years" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700" data-i18n="calculator.calculate">Calculate</button>
            <div id="fd-result" class="calculator-result hidden"></div>
        </form>
    </script>

    <script type="text/html-template" id="goal-calc-template">
        <form id="goal-form" class="space-y-4">
            <div>
                <label for="goal-target" class="block text-sm font-medium text-gray-700" data-i18n="calculator.goal.target">Target Amount (‚Çπ)</label>
                <input type="number" id="goal-target" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>
             <div>
                <label for="goal-years" class="block text-sm font-medium text-gray-700" data-i18n="calculator.goal.years">Time Period (Years)</label>
                <input type="number" id="goal-years" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <div>
                <label for="goal-rate" class="block text-sm font-medium text-gray-700" data-i18n="calculator.goal.rate">Expected Return Rate (% p.a.)</label>
                <input type="number" id="goal-rate" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700" data-i18n="calculator.calculate">Calculate</button>
            <div id="goal-result" class="calculator-result hidden"></div>
        </form>
    </script>


    <script>
        // DOM Elements
        const chatWindowScroller = document.getElementById('chat-window');
        const chatMessageList = document.getElementById('chat-message-list');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const langSelector = document.getElementById('language-selector');
        const langButtons = document.querySelectorAll('.lang-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        const micButton = document.getElementById('mic-button');
        const userProfile = document.getElementById('user-profile');
        const riskLevelEl = document.getElementById('risk-level');
        const goalsCountEl = document.getElementById('goals-count');
        const progressTracker = document.getElementById('progress-tracker');
        const achievements = document.getElementById('achievements');
        const sessionPrompt = document.getElementById('session-prompt');
        const sessionYes = document.getElementById('session-yes');
        const sessionNo = document.getElementById('session-no');
        const toolsSection = document.getElementById('tools-section');

        // RE-ADDED: Calculator Modal DOM Elements
        const calculatorModal = document.getElementById('calculator-modal');
        const calculatorModalContent = document.getElementById('calculator-modal-content');
        const calculatorModalTitle = document.getElementById('calculator-modal-title');
        const calculatorModalBody = document.getElementById('calculator-modal-body');
        const calculatorModalClose = document.getElementById('calculator-modal-close');

        // State
        let selectedLanguage = 'en';
        let isLoading = false;
        let chatHistory = [];
        let userProfileData = {
            risk: null,
            goals: [],
            progress: []
        };
        
        // Track incomplete JSON responses for retry
        let lastJSONRequest = null;
        
        // Speech API State
        let isRecording = false;
        let recognition;
        const speechSynthesis = window.speechSynthesis;
        let voices = [];
        const langCodeMap = { en: 'en-US', hi: 'hi-IN', or: 'or-IN' };

        // NEW: Internationalization (i18n) Object
        const i18n = {
            en: {
                sidebarTitle: "Financial Chatbot",
                langPrompt: "Choose Language:",
                toolsTitle: "Quick Financial Tools",
                tools: {
                    sip: "SIP Calculator",
                    emi: "EMI Calculator",
                    fd: "FD Returns",
                    goal: "Goal Planner"
                },
                welcomeMsg: "Hello! I am FinHelp, your personal financial guide. What's your main financial goal right now?",
                inputPlaceholder: "Type or speak your message...",
                calculator: {
                    sip: {
                        title: "SIP Calculator",
                        investment: "Monthly Investment (‚Çπ)",
                        rate: "Expected Return Rate (% p.a.)",
                        years: "Time Period (Years)",
                        resultTitle: "Maturity Value",
                        invested: "Total Invested",
                        gains: "Total Gains"
                    },
                    emi: {
                        title: "EMI Calculator",
                        amount: "Loan Amount (‚Çπ)",
                        rate: "Interest Rate (% p.a.)",
                        months: "Loan Tenure (Months)",
                        resultTitle: "Monthly EMI",
                        interest: "Total Interest",
                        total: "Total Payment"
                    },
                    fd: {
                        title: "FD Returns Calculator",
                        amount: "Total Investment (‚Çπ)",
                        rate: "Interest Rate (% p.a.)",
                        years: "Time Period (Years)",
                        resultTitle: "Maturity Value",
                        invested: "Total Invested",
                        gains: "Total Gains"
                    },
                    goal: {
                        title: "Goal Planner",
                        target: "Target Amount (‚Çπ)",
                        years: "Time Period (Years)",
                        rate: "Expected Return Rate (% p.a.)",
                        resultTitle: "Monthly SIP Needed"
                    },
                    calculate: "Calculate",
                    close: "Close", // This is for future use if needed
                    analyze: "‚ú® Analyze My Results", // NEW
                    analyzing: "Analyzing..." // NEW
                }
            },
            hi: {
                sidebarTitle: "‡§µ‡§ø‡§§‡•ç‡§§‡•Ä‡§Ø ‡§ö‡•à‡§ü‡§¨‡•â‡§ü",
                langPrompt: "‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç:",
                toolsTitle: "‡§§‡•ç‡§µ‡§∞‡§ø‡§§ ‡§µ‡§ø‡§§‡•ç‡§§‡•Ä‡§Ø ‡§â‡§™‡§ï‡§∞‡§£",
                tools: {
                    sip: "‡§è‡§∏‡§Ü‡§à‡§™‡•Ä ‡§ï‡•à‡§≤‡§ï‡•Å‡§≤‡•á‡§ü‡§∞",
                    emi: "‡§à‡§è‡§Æ‡§Ü‡§à ‡§ï‡•à‡§≤‡§ï‡•Å‡§≤‡•á‡§ü‡§∞",
                    fd: "‡§è‡§´‡§°‡•Ä ‡§∞‡§ø‡§ü‡§∞‡•ç‡§®",
                    goal: "‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§Ø‡•ã‡§ú‡§®‡§æ‡§ï‡§æ‡§∞"
                },
                welcomeMsg: "‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§´‡§ø‡§®‡§π‡•á‡§≤‡•ç‡§™, ‡§Ü‡§™‡§ï‡§æ ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§ó‡§§ ‡§µ‡§ø‡§§‡•ç‡§§‡•Ä‡§Ø ‡§ó‡§æ‡§á‡§° ‡§π‡•Ç‡§Å‡•§ ‡§Ö‡§≠‡•Ä ‡§Ü‡§™‡§ï‡§æ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§µ‡§ø‡§§‡•ç‡§§‡•Ä‡§Ø ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?",
                inputPlaceholder: "‡§Ö‡§™‡§®‡§æ ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§≤‡§ø‡§ñ‡•á‡§Ç ‡§Ø‡§æ ‡§¨‡•ã‡§≤‡•á‡§Ç...",
                calculator: {
                    sip: {
                        title: "‡§è‡§∏‡§Ü‡§à‡§™‡•Ä ‡§ï‡•à‡§≤‡§ï‡•Å‡§≤‡•á‡§ü‡§∞",
                        investment: "‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§®‡§ø‡§µ‡•á‡§∂ (‚Çπ)",
                        rate: "‡§Ö‡§™‡•á‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∞‡§ø‡§ü‡§∞‡•ç‡§® ‡§¶‡§∞ (% ‡§™‡•ç‡§∞‡§§‡§ø ‡§µ‡§∞‡•ç‡§∑)",
                        years: "‡§∏‡§Æ‡§Ø ‡§Ö‡§µ‡§ß‡§ø (‡§µ‡§∞‡•ç‡§∑)",
                        resultTitle: "‡§™‡§∞‡§ø‡§™‡§ï‡•ç‡§µ‡§§‡§æ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø",
                        invested: "‡§ï‡•Å‡§≤ ‡§®‡§ø‡§µ‡•á‡§∂‡§ø‡§§",
                        gains: "‡§ï‡•Å‡§≤ ‡§≤‡§æ‡§≠"
                    },
                    emi: {
                        title: "‡§à‡§è‡§Æ‡§Ü‡§à ‡§ï‡•à‡§≤‡§ï‡•Å‡§≤‡•á‡§ü‡§∞",
                        amount: "‡§ã‡§£ ‡§∞‡§æ‡§∂‡§ø (‚Çπ)",
                        rate: "‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§¶‡§∞ (% ‡§™‡•ç‡§∞‡§§‡§ø ‡§µ‡§∞‡•ç‡§∑)",
                        months: "‡§ã‡§£ ‡§Ö‡§µ‡§ß‡§ø (‡§Æ‡§π‡•Ä‡§®‡•á)",
                        resultTitle: "‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§à‡§è‡§Æ‡§Ü‡§à",
                        interest: "‡§ï‡•Å‡§≤ ‡§¨‡•ç‡§Ø‡§æ‡§ú",
                        total: "‡§ï‡•Å‡§≤ ‡§≠‡•Å‡§ó‡§§‡§æ‡§®"
                    },
                    fd: {
                        title: "‡§è‡§´‡§°‡•Ä ‡§∞‡§ø‡§ü‡§∞‡•ç‡§® ‡§ï‡•à‡§≤‡§ï‡•Å‡§≤‡•á‡§ü‡§∞",
                        amount: "‡§ï‡•Å‡§≤ ‡§®‡§ø‡§µ‡•á‡§∂ (‚Çπ)",
                        rate: "‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§¶‡§∞ (% ‡§™‡•ç‡§∞‡§§‡§ø ‡§µ‡§∞‡•ç‡§∑)",
                        years: "‡§∏‡§Æ‡§Ø ‡§Ö‡§µ‡§ß‡§ø (‡§µ‡§∞‡•ç‡§∑)",
                        resultTitle: "‡§™‡§∞‡§ø‡§™‡§ï‡•ç‡§µ‡§§‡§æ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø",
                        invested: "‡§ï‡•Å‡§≤ ‡§®‡§ø‡§µ‡•á‡§∂‡§ø‡§§",
                        gains: "‡§ï‡•Å‡§≤ ‡§≤‡§æ‡§≠"
                    },
                    goal: {
                        title: "‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§Ø‡•ã‡§ú‡§®‡§æ‡§ï‡§æ‡§∞",
                        target: "‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§∞‡§æ‡§∂‡§ø (‚Çπ)",
                        years: "‡§∏‡§Æ‡§Ø ‡§Ö‡§µ‡§ß‡§ø (‡§µ‡§∞‡•ç‡§∑)",
                        rate: "‡§Ö‡§™‡•á‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∞‡§ø‡§ü‡§∞‡•ç‡§® ‡§¶‡§∞ (% ‡§™‡•ç‡§∞‡§§‡§ø ‡§µ‡§∞‡•ç‡§∑)",
                        resultTitle: "‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§è‡§∏‡§Ü‡§à‡§™‡•Ä"
                    },
                    calculate: "‡§ó‡§£‡§®‡§æ ‡§ï‡§∞‡•á‡§Ç",
                    close: "‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç",
                    analyze: "‚ú® ‡§Æ‡•á‡§∞‡•á ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡•á‡§Ç", // NEW
                    analyzing: "‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à..." // NEW
                }
            },
            or: { // Odia translations (placeholder, can be filled)
                sidebarTitle: "‡¨Ü‡¨∞‡≠ç‡¨•‡¨ø‡¨ï ‡¨ö‡¨æ‡¨ü‡¨¨‡¨ü‡≠ç",
                langPrompt: "‡¨≠‡¨æ‡¨∑‡¨æ ‡¨¨‡¨æ‡¨õ‡¨®‡≠ç‡¨§‡≠Å:",
                toolsTitle: "‡¨∂‡≠Ä‡¨ò‡≠ç‡¨∞ ‡¨Ü‡¨∞‡≠ç‡¨•‡¨ø‡¨ï ‡¨â‡¨™‡¨ï‡¨∞‡¨£",
                tools: {
                    sip: "SIP ‡¨ï‡¨æ‡¨≤‡¨ï‡≠Å‡¨≤‡≠á‡¨ü‡¨∞",
                    emi: "EMI ‡¨ï‡¨æ‡¨≤‡¨ï‡≠Å‡¨≤‡≠á‡¨ü‡¨∞",
                    fd: "FD ‡¨∞‡¨ø‡¨ü‡¨∞‡≠ç‡¨®‡¨∏‡≠ç",
                    goal: "‡¨≤‡¨ï‡≠ç‡¨∑‡≠ç‡≠ü ‡¨Ø‡≠ã‡¨ú‡¨®‡¨æ‡¨ï‡¨æ‡¨∞‡≠Ä"
                },
                welcomeMsg: "‡¨®‡¨Æ‡¨∏‡≠ç‡¨ï‡¨æ‡¨∞! ‡¨Æ‡≠Å‡¨Å ‡¨´‡¨ø‡¨®‡¨π‡≠á‡¨≤‡≠ç‡¨™, ‡¨Ü‡¨™‡¨£‡¨ô‡≠ç‡¨ï‡¨∞ ‡¨¨‡≠ç‡≠ü‡¨ï‡≠ç‡¨§‡¨ø‡¨ó‡¨§ ‡¨Ü‡¨∞‡≠ç‡¨•‡¨ø‡¨ï ‡¨ó‡¨æ‡¨á‡¨°‡≠ç | ‡¨¨‡¨∞‡≠ç‡¨§‡≠ç‡¨§‡¨Æ‡¨æ‡¨® ‡¨Ü‡¨™‡¨£‡¨ô‡≠ç‡¨ï‡¨∞ ‡¨Æ‡≠Å‡¨ñ‡≠ç‡≠ü ‡¨Ü‡¨∞‡≠ç‡¨•‡¨ø‡¨ï ‡¨≤‡¨ï‡≠ç‡¨∑‡≠ç‡≠ü ‡¨ï'‡¨£?",
                inputPlaceholder: "‡¨Ü‡¨™‡¨£‡¨ô‡≠ç‡¨ï‡¨∞ ‡¨¨‡¨æ‡¨∞‡≠ç‡¨§‡≠ç‡¨§‡¨æ ‡¨ü‡¨æ‡¨á‡¨™‡≠ç ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å ‡¨ï‡¨ø‡¨Æ‡≠ç‡¨¨‡¨æ ‡¨ï‡≠Å‡¨π‡¨®‡≠ç‡¨§‡≠Å...",
                calculator: {
                    sip: {
                        title: "SIP ‡¨ï‡¨æ‡¨≤‡¨ï‡≠Å‡¨≤‡≠á‡¨ü‡¨∞",
                        investment: "‡¨Æ‡¨æ‡¨∏‡¨ø‡¨ï ‡¨®‡¨ø‡¨¨‡≠á‡¨∂ (‚Çπ)",
                        rate: "‡¨Ü‡¨∂‡¨æ ‡¨ï‡¨∞‡¨æ‡¨Ø‡¨æ‡¨â‡¨•‡¨ø‡¨¨‡¨æ ‡¨∞‡¨ø‡¨ü‡¨∞‡≠ç‡¨® ‡¨π‡¨æ‡¨∞ (% p.a.)",
                        years: "‡¨∏‡¨Æ‡≠ü ‡¨Ö‡¨¨‡¨ß‡¨ø (‡¨¨‡¨∞‡≠ç‡¨∑)",
                        resultTitle: "‡¨™‡¨∞‡¨ø‡¨™‡¨ï‡≠ç‡≠±‡¨§‡¨æ ‡¨Æ‡≠Ç‡¨≤‡≠ç‡≠ü",
                        invested: "‡¨Æ‡≠ã‡¨ü ‡¨®‡¨ø‡¨¨‡≠á‡¨∂",
                        gains: "‡¨Æ‡≠ã‡¨ü ‡¨≤‡¨æ‡¨≠"
                    },
                    emi: {
                        title: "EMI ‡¨ï‡¨æ‡¨≤‡¨ï‡≠Å‡¨≤‡≠á‡¨ü‡¨∞",
                        amount: "‡¨ã‡¨£ ‡¨∞‡¨æ‡¨∂‡¨ø (‚Çπ)",
                        rate: "‡¨∏‡≠Å‡¨ß ‡¨π‡¨æ‡¨∞ (% p.a.)",
                        months: "‡¨ã‡¨£ ‡¨Ö‡¨¨‡¨ß‡¨ø (‡¨Æ‡¨æ‡¨∏)",
                        resultTitle: "‡¨Æ‡¨æ‡¨∏‡¨ø‡¨ï EMI",
                        interest: "‡¨Æ‡≠ã‡¨ü ‡¨∏‡≠Å‡¨ß",
                        total: "‡¨Æ‡≠ã‡¨ü ‡¨¶‡≠á‡≠ü"
                    },
                    fd: {
                        title: "FD ‡¨∞‡¨ø‡¨ü‡¨∞‡≠ç‡¨®‡¨∏‡≠ç ‡¨ï‡¨æ‡¨≤‡¨ï‡≠Å‡¨≤‡≠á‡¨ü‡¨∞",
                        amount: "‡¨Æ‡≠ã‡¨ü ‡¨®‡¨ø‡¨¨‡≠á‡¨∂ (‚Çπ)",
                        rate: "‡¨∏‡≠Å‡¨ß ‡¨π‡¨æ‡¨∞ (% p.a.)",
                        years: "‡¨∏‡¨Æ‡≠ü ‡¨Ö‡¨¨‡¨ß‡¨ø (‡¨¨‡¨∞‡≠ç‡¨∑)",
                        resultTitle: "‡¨™‡¨∞‡¨ø‡¨™‡¨ï‡≠ç‡≠±‡¨§‡¨æ ‡¨Æ‡≠Ç‡¨≤‡≠ç‡≠ü",
                        invested: "‡¨Æ‡≠ã‡¨ü ‡¨®‡¨ø‡¨¨‡≠á‡¨∂",
                        gains: "‡¨Æ‡≠ã‡¨ü ‡¨≤‡¨æ‡¨≠"
                    },
                    goal: {
                        title: "‡¨≤‡¨ï‡≠ç‡¨∑‡≠ç‡≠ü ‡¨Ø‡≠ã‡¨ú‡¨®‡¨æ‡¨ï‡¨æ‡¨∞‡≠Ä",
                        target: "‡¨≤‡¨ï‡≠ç‡¨∑‡≠ç‡≠ü ‡¨∞‡¨æ‡¨∂‡¨ø (‚Çπ)",
                        years: "‡¨∏‡¨Æ‡≠ü ‡¨Ö‡¨¨‡¨ß‡¨ø (‡¨¨‡¨∞‡≠ç‡¨∑)",
                        rate: "‡¨Ü‡¨∂‡¨æ ‡¨ï‡¨∞‡¨æ‡¨Ø‡¨æ‡¨â‡¨•‡¨ø‡¨¨‡¨æ ‡¨∞‡¨ø‡¨ü‡¨∞‡≠ç‡¨® ‡¨π‡¨æ‡¨∞ (% p.a.)",
                        resultTitle: "‡¨Ü‡¨¨‡¨∂‡≠ç‡≠ü‡¨ï ‡¨Æ‡¨æ‡¨∏‡¨ø‡¨ï SIP"
                    },
                    calculate: "‡¨ó‡¨£‡¨®‡¨æ ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å",
                    close: "‡¨¨‡¨®‡≠ç‡¨¶ ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å",
                    analyze: "‡¨´‡¨≥‡¨æ‡¨´‡¨≥ ‡¨¨‡¨ø‡¨∂‡≠ç‡¨≥‡≠á‡¨∑‡¨£ ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å |", // NEW
                    analyzing: "‡¨¨‡¨ø‡¨∂‡≠ç‡¨≥‡≠á‡¨∑‡¨£ ‡¨ï‡¨∞‡≠Å‡¨õ‡¨ø..." // NEW
                }
            }
        };

        // ENHANCED: API Configuration with better JSON instructions
        const SYSTEM_PROMPT_TEMPLATE = `You are FinHelp, a friendly financial advisor chatbot for Tier-3 town users in India.

**CRITICAL RULES FOR JSON RESPONSES:**
1. **Complete JSON Only:** When sending product recommendations, send COMPLETE, VALID JSON only
2. **No Truncation:** Ensure the JSON is complete - no cut-off responses
3. **Valid Structure:** Every product must have: name, description, risk, returns
4. **Format:** Use this exact format:
\`\`\`json
[
  {
    "name": "Product Name",
    "description": "Complete description...",
    "risk": "Low/Medium/High", 
    "returns": "X-Y% p.a."
  }
]
\`\`\`

**General Rules:**
1. **Language:** Respond ONLY in {LANGUAGE}.
2. **Simplicity:** Use VERY simple, non-jargon language.
3. **One Question:** Ask only ONE question at a time.
4. **Flow & Tokens:** Follow this exact flow:

    **Step 1: Goal**
    * Ask for financial goal
    * End response with: \`[STEP_COMPLETE:goal]\`

    **Step 2: Time**
    * Ask for time horizon
    * End response with: \`[STEP_COMPLETE:time]\`

    **Step 3: Risk**
    * Ask for risk level (A/B/C)
    * End with appropriate token: \`[STEP_COMPLETE:risk:Low/Medium/High]\`

    **Step 4: Recommendation**
    * When user asks for plan, respond ONLY with COMPLETE JSON as shown above
`;

        // Core Functions

        // NEW: Function to update all UI text based on selected language
        function updateUIText(lang, element = document) { // Added element parameter
            const langData = i18n[lang];
            if (!langData) return;

            element.querySelectorAll('[data-i18n]').forEach(el => { // Use element.querySelectorAll
                const key = el.dataset.i18n;
                let text = langData;
                try {
                    key.split('.').forEach(part => {
                        text = text[part];
                    });
                    if (typeof text === 'string') {
                        el.textContent = text;
                    }
                } catch (e) {
                    console.warn(`i18n key not found: ${key} for lang: ${lang}`);
                }
            });

            // Update placeholder
            if (element === document) { // Only update placeholder if scanning whole document
                chatInput.placeholder = langData.inputPlaceholder || "Type your message...";
            }
        }

        function addMessageToChat(sender, text, isHTML = false) {
            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble p-4 rounded-lg';
            
            const content = document.createElement('span');
            content.className = 'chat-bubble-content';
            
            if (isHTML) {
                content.innerHTML = text;
            } else {
                content.innerHTML = text.replace(/\n/g, '<br>');
            }
            
            bubble.appendChild(content);

            if (sender === 'user') {
                bubble.classList.add('chat-bubble-user');
            } else {
                bubble.classList.add('chat-bubble-bot');
                
                // Add speak button for text messages only
                if (!isHTML) {
                    const speakBtn = document.createElement('button');
                    speakBtn.className = 'speak-btn';
                    speakBtn.title = 'Listen to this message';
                    speakBtn.dataset.text = text;
                    
                    speakBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                          <path d="M7.25 8.25a.75.75 0 000 1.5h.5a.75.75 0 000-1.5h-.5zM9 8.25a.75.75 0 000 1.5h.5a.75.75 0 000-1.5H9zM10.75 8.25a.75.75 0 000 1.5h.5a.75.75 0 000-1.5h-.5zM12.5 8.25a.75.75 0 000 1.5h.5a.75.75 0 000-1.5h-.5z" />
                          <path fill-rule="evenodd" d="M3.5 6A2.5 2.5 0 016 3.5h8A2.5 2.5 0 0116.5 6v8a2.5 2.5 0 01-2.5 2.5H6A2.5 2.5 0 013.5 14V6zm2.06 1.97a.75.75 0 011.06 0 3.5 3.5 0 010 4.95.75.75 0 11-1.06 1.06 5 5 0 000-7.07.75.75 0 010 1.06z" clip-rule="evenodd" />
                        </svg>
                    `;
                    bubble.appendChild(speakBtn);
                }
            }
            
            chatMessageList.appendChild(bubble);
            chatWindowScroller.scrollTop = chatWindowScroller.scrollHeight;
            
            if (isHTML) {
                attachDynamicListeners(bubble);
            }
        }

        // ENHANCED: Better JSON Detection with Incomplete Response Detection
        function extractJSONFromResponse(response) {
            let jsonString = null;
            let remainingText = response;
            let isIncomplete = false;
            
            // Method 1: Check for code blocks first (most reliable)
            const codeBlockMatch = response.match(/```json\s*([\s\S]*?)```/);
            if (codeBlockMatch && codeBlockMatch[1]) {
                jsonString = codeBlockMatch[1].trim();
                remainingText = response.replace(codeBlockMatch[0], '').trim();
                
                // Check for incomplete JSON in code blocks
                if (!jsonString.endsWith(']') || !isValidJSONStructure(jsonString)) {
                    isIncomplete = true;
                }
                return { jsonString, remainingText, isIncomplete };
            }
            
            // Method 2: Check for raw JSON array
            const jsonArrayMatch = response.match(/(\[[\s\S]{20,})/);
            if (jsonArrayMatch) {
                const potentialJSON = jsonArrayMatch[1];
                
                // Enhanced validation for incomplete JSON
                if (potentialJSON.includes('name') && potentialJSON.includes('description')) {
                    jsonString = potentialJSON;
                    remainingText = response.replace(jsonArrayMatch[0], '').trim();
                    
                    // Check if JSON is complete
                    if (!potentialJSON.endsWith(']') || !isValidJSONStructure(potentialJSON)) {
                        isIncomplete = true;
                    }
                }
            }
            
            return { jsonString, remainingText, isIncomplete };
        }

        // NEW: Validate JSON structure for completeness
        function isValidJSONStructure(jsonString) {
            try {
                // Quick check for basic structure
                if (!jsonString.includes('"name"') || !jsonString.includes('"description"')) {
                    return false;
                }
                
                // Try to parse - if it fails, structure is invalid
                JSON.parse(jsonString);
                return true;
            } catch (e) {
                return false;
            }
        }

        // ENHANCED: JSON parsing with retry detection
        function parseProductJSON(jsonString, isRetry = false) {
            try {
                // First, check if JSON looks complete
                if (!jsonString.trim().endsWith(']')) {
                    throw new Error("INCOMPLETE_JSON");
                }
                
                const products = JSON.parse(jsonString);
                
                // Validate structure
                if (!Array.isArray(products)) {
                    throw new Error("Expected an array of products");
                }
                
                if (products.length === 0) {
                    throw new Error("No products found in the response");
                }
                
                const validProducts = [];
                const invalidProducts = [];
                
                products.forEach((product, index) => {
                    if (product && 
                        typeof product.name === 'string' && 
                        typeof product.description === 'string' &&
                        typeof product.risk === 'string' &&
                        typeof product.returns === 'string') {
                        validProducts.push(product);
                    } else {
                        invalidProducts.push(index);
                    }
                });
                
                if (validProducts.length === 0) {
                    throw new Error("No valid products found");
                }
                
                if (invalidProducts.length > 0) {
                    console.warn(`Invalid products at indices: ${invalidProducts.join(', ')}`);
                }
                
                return validProducts;
                
            } catch (error) {
                console.error("JSON parsing failed:", error);
                
                // Special handling for incomplete JSON
                if (error.message === "INCOMPLETE_JSON") {
                    if (!isRetry) {
                        throw new Error("INCOMPLETE_JSON_RETRY");
                    } else {
                        throw new Error("I'm having trouble generating a complete plan. The response seems to be cut off. Please try asking for your plan again.");
                    }
                }
                
                throw new Error(`I couldn't process the investment plan properly. ${isRetry ? 'Please try asking again.' : 'Let me try to generate it again.'}`);
            }
        }

        function createProductCard(product) {
            return `
                <div class="product-card my-3">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-semibold">${product.name}</h4>
                        <span class="text-xs px-2 py-1 rounded-full ${product.risk === 'Low' ? 'bg-green-100 text-green-800' : product.risk === 'Medium' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">${product.risk} Risk</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-3">${product.description}</p>
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-gray-700">Expected Returns: <strong class="text-gray-900">${product.returns}</strong></span>
                        <button class="learn-more-btn px-3 py-1 bg-blue-100 text-blue-700 rounded-full font-medium hover:bg-blue-200 transition-colors" data-product="${product.name}">Learn More</button>
                    </div>
                </div>
            `;
        }

        // NEW: Create retry button for incomplete JSON
        function createRetryButton() {
            return `
                <div class="product-card my-3 bg-orange-50 border-orange-200">
                    <div class="text-center p-4">
                        <p class="text-orange-800 mb-3">I had trouble generating your complete investment plan. The response seems to be cut off.</p>
                        <button class="retry-btn" id="retry-json-btn">
                            üîÑ Try Generating Plan Again
                        </button>
                    </div>
                </div>
            `;
        }

        function processBotResponse(response) {
            let token = null;
            
            // 1. Check for progress tokens first
            const tokenMatch = response.match(/\[STEP_COMPLETE:(\w+)(?::([\w\s]+))?\]/);
            if (tokenMatch) {
                token = {
                    step: tokenMatch[1],
                    value: tokenMatch[2] || null
                };
                response = response.replace(tokenMatch[0], '').trim();
            }

            // 2. Extract JSON and remaining text with completeness check
            const { jsonString, remainingText, isIncomplete } = extractJSONFromResponse(response);
            
            return { token, jsonString, text: remainingText, isIncomplete };
        }

        function updateProfileState(step, value = null) {
            if (!step) return;

            if (!userProfileData.progress.includes(step)) {
                userProfileData.progress.push(step);
            }

            if (step === 'goal' && userProfileData.goals.length === 0) {
                userProfileData.goals.push("New Goal");
            } else if (step === 'risk' && value) {
                userProfileData.risk = value;
            }
        }

        function renderUIFromState() {
            const data = userProfileData;

            // Update Progress Tracker
            if (data.progress.length > 0) {
                progressTracker.classList.remove('hidden');
                const steps = ['goal', 'time', 'risk', 'recommendation'];
                steps.forEach(s => {
                    const dot = document.querySelector(`.step-dot[data-step="${s}"]`);
                    if (dot) {
                        if (data.progress.includes(s)) {
                            dot.classList.remove('bg-gray-300');
                            dot.classList.add('bg-green-500');
                        } else {
                            dot.classList.remove('bg-green-500');
                            dot.classList.add('bg-gray-300');
                        }
                    }
                });
            } else {
                progressTracker.classList.add('hidden');
            }

            // Update User Profile
            if (data.risk || data.goals.length > 0) {
                userProfile.classList.remove('hidden');
                goalsCountEl.textContent = data.goals.length;
                
                if (data.risk) {
                    riskLevelEl.textContent = data.risk;
                    let riskColor = 'text-green-800';
                    if (data.risk === 'Medium') riskColor = 'text-yellow-800';
                    if (data.risk === 'High') riskColor = 'text-red-800';
                    riskLevelEl.className = `font-bold ${riskColor}`;
                } else {
                    riskLevelEl.textContent = 'Not set';
                    riskLevelEl.className = 'font-bold';
                }
            } else {
                userProfile.classList.add('hidden');
            }

            // Update Achievements
            document.getElementById('achieve-goal').classList.toggle('opacity-30', !data.progress.includes('goal'));
            document.getElementById('achieve-risk').classList.toggle('opacity-30', !data.progress.includes('risk'));
            document.getElementById('achieve-invest').classList.toggle('opacity-30', !data.progress.includes('recommendation'));
        }

        // ENHANCED: Main chat handler with JSON retry logic
        async function handleChatSubmit(e, isRetry = false) {
            if (e) e.preventDefault();
            hideError();
            speechSynthesis.cancel();
            
            const userInput = isRetry ? "show me my investment plan" : chatInput.value.trim();
            if (!userInput || isLoading) return;

            if (!isRetry) {
                addMessageToChat('user', userInput);
                chatInput.value = '';
            }
            
            chatHistory.push({ role: 'user', parts: [{ text: userInput }] });
            setLoading(true);

            try {
                const botResponse = await callGeminiAPI(chatHistory);
                chatHistory.push({ role: 'model', parts: [{ text: botResponse }] });

                // Process response
                const { token, jsonString, text, isIncomplete } = processBotResponse(botResponse);
                
                // Update state
                if (token) {
                    updateProfileState(token.step, token.value);
                }

                let cardHTML = null;
                let products = null;
                let jsonError = null;

                // Handle JSON with retry logic
                if (jsonString) {
                    try {
                        products = parseProductJSON(jsonString, isRetry);
                        cardHTML = products.map(createProductCard).join('');
                        
                        // Only mark recommendation complete after successful JSON processing
                        updateProfileState('recommendation');
                        
                    } catch (error) {
                        jsonError = error.message;
                        
                        // Special handling for incomplete JSON with retry option
                        if (error.message === "INCOMPLETE_JSON_RETRY" && !isRetry) {
                            cardHTML = createRetryButton();
                        } else {
                            showError(error.message);
                        }
                    }
                }

                // Render UI updates
                renderUIFromState();

                // Add messages to chat
                if (cardHTML) {
                    // Add explanatory text if it exists
                    if (text && !jsonError) {
                        addMessageToChat('bot', text);
                    }
                    // Add product cards or retry button
                    addMessageToChat('bot', cardHTML, true);
                } else if (text && !jsonError) {
                    // No cards, just add the text
                    addMessageToChat('bot', text);
                }

                saveUserSession();

            } catch (error) {
                console.error("API Error:", error);
                showError("Sorry, I'm having trouble connecting. Please try again.");
                if (!isRetry) {
                    chatHistory.pop();
                    chatHistory.pop();
                }
            } finally {
                setLoading(false);
            }
        }

        // API Call Function
        async function callGeminiAPI(history) {
            const apiKey = "AIzaSyBSJF4yypmcxyCPzDpN8pdu8pXJd6sqDD8";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const finalSystemPrompt = SYSTEM_PROMPT_TEMPLATE.replace(
                '{LANGUAGE}', 
                i18n[selectedLanguage].sidebarTitle || 'English' // Use a known key
            );

            const payload = {
                contents: history,
                systemInstruction: {
                    parts: [{ text: finalSystemPrompt }]
                },
                generationConfig: {
                    temperature: 0.7,
                    topK: 1,
                    topP: 1,
                    maxOutputTokens: 1024, // Increased for complete JSON
                }
            };
            
            return await callGeminiWithRetry(payload); // NEW: Use retry wrapper
        }

        // NEW: Simplified Gemini call for one-off advice (calculators, learn more)
        async function callGeminiForAdvice(prompt) {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    temperature: 0.5, // Slightly more creative for advice
                    topK: 1,
                    topP: 1,
                    maxOutputTokens: 512,
                }
            };
            return await callGeminiWithRetry(payload); // NEW: Use retry wrapper
        }

        // NEW: Wrapper function for all fetch calls with retry logic
        async function callGeminiWithRetry(payload) {
            const apiKey = "AIzaSyBSJF4yypmcxyCPzDpN8pdu8pXJd6sqDD8"; // This key is managed externally
            const apiUrl = `https://generativela${""}nguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            let response;
            let retries = 3;
            let delay = 1000;

            for (let i = 0; i < retries; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        
                        if (!result.candidates || result.candidates.length === 0 || !result.candidates[0].content) {
                            // Check for safety ratings
                            if (result.promptFeedback && result.promptFeedback.blockReason) {
                                console.warn(`Gemini call blocked: ${result.promptFeedback.blockReason}`);
                                throw new Error("My response was blocked for safety reasons. Please try a different query.");
                            }
                            throw new Error("I'm sorry, I couldn't generate a response for that. Could you please rephrase?");
                        }
                        
                        const text = result.candidates[0].content.parts[0].text;
                        
                        if (!text) {
                             throw new Error("Received an empty response from the AI.");
                        }
                        
                        return text;
                    } else if (response.status === 429 || response.status >= 500) {
                        // Throttling or server error, wait and retry
                        console.warn(`Gemini API error ${response.status}, retrying...`);
                        throw new Error(`Server error: ${response.status}`);
                    } else {
                        // Client-side error (e.g., bad request)
                        const errorResult = await response.json();
                        console.error("Gemini API client error:", errorResult);
                        throw new Error(`API error: ${errorResult.error.message}`);
                    }

                } catch (error) {
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    } else {
                        // Last retry failed
                        throw error;
                    }
                }
            }
            throw new Error("Failed to get a response from the AI after multiple attempts.");
        }


        // Utility Functions
        function setLoading(state) {
             isLoading = state;
             if (state) {
                 loadingIndicator.classList.remove('hidden');
                 loadingIndicator.classList.add('flex');
                 sendButton.disabled = true;
                 chatInput.disabled = true;
                 micButton.disabled = true;
             } else {
                 loadingIndicator.classList.add('hidden');
                 loadingIndicator.classList.remove('flex');
                 sendButton.disabled = false;
                 chatInput.disabled = false;
                 micButton.disabled = false;
                 chatInput.focus();
             }
        }

        function showError(text) {
            errorMessage.textContent = text;
            errorMessage.classList.remove('hidden');
        }

        function hideError() {
            errorMessage.textContent = '';
            errorMessage.classList.add('hidden');
        }

        function updateLangButtons(activeLang) {
            langButtons.forEach(button => {
                if (button.dataset.lang === activeLang) {
                    button.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'focus:ring-gray-400');
                    button.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'focus:ring-blue-500');
                    button.disabled = true;
                } else {
                    button.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'focus:ring-gray-400');
                    button.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'focus:ring-blue-500');
                    button.disabled = false;
                }
            });
            
            chatInput.disabled = false;
            sendButton.disabled = false;
            micButton.disabled = false;
            // Placeholder update is now handled by updateUIText
        }

        function resetChat(isNewSession = true) {
            chatMessageList.innerHTML = '';
            chatHistory = [];
            hideError();
            
            userProfileData = { risk: null, goals: [], progress: [] };
            renderUIFromState();
            
            if (isNewSession) {
                const welcomeText = i18n[selectedLanguage].welcomeMsg;
                addMessageToChat('bot', welcomeText);
                chatHistory.push({ role: 'model', parts: [{ text: welcomeText }] });
            }
        }

        // Speech Functions
        function setupSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = langCodeMap[selectedLanguage];

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    chatInput.value = transcript;
                };

                recognition.onstart = () => {
                    isRecording = true;
                    micButton.classList.add('is-recording');
                    micButton.title = "Stop recording";
                };

                recognition.onend = () => {
                    isRecording = false;
                    micButton.classList.remove('is-recording');
                    micButton.title = "Speak your message";
                };

                recognition.onerror = (event) => {
                    let errorMsg = 'Speech recognition error';
                    if (event.error == 'no-speech') {
                        errorMsg = 'No speech was detected. Please try again.';
                    } else if (event.error == 'audio-capture') {
                        errorMsg = 'Microphone problem. Please ensure it is connected and enabled.';
                    } else if (event.error == 'not-allowed') {
                        errorMsg = 'Permission to use microphone was denied. Please allow it in your browser settings.';
                    }
                    showError(errorMsg);
                };
            } else {
                micButton.style.display = 'none';
            }
        }

        function toggleRecording(e) {
            e.preventDefault();
            hideError();
            if (isRecording) {
                recognition.stop();
            } else {
                try {
                    recognition.lang = langCodeMap[selectedLanguage];
                    recognition.start();
                } catch(err) {
                    showError("Could not start voice recognition. Please try again.");
                }
            }
        }

        function loadVoices() {
            voices = speechSynthesis.getVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = () => voices = speechSynthesis.getVoices();
            }
        }
        
        function speakText(text, langCode) {
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = langCode;
            let voice = voices.find(v => v.lang === langCode);
            if (!voice) {
                voice = voices.find(v => v.lang.startsWith(langCode.split('-')[0]));
            }
            if (voice) {
                utterance.voice = voice;
            }
            speechSynthesis.speak(utterance);
        }

        function handleSpeakButtonClick(e) {
            const button = e.target.closest('.speak-btn');
            if (button) {
                const text = button.dataset.text;
                const langCode = langCodeMap[selectedLanguage];
                speakText(text, langCode);
            }
        }

        // ENHANCED: Dynamic listeners with retry button and NEW AI "Learn More"
        async function attachDynamicListeners(parentElement) {
            // Learn More buttons
            const learnMoreBtns = parentElement.querySelectorAll('.learn-more-btn');
            for (const btn of learnMoreBtns) {
                btn.addEventListener('click', async () => {
                    const productName = btn.dataset.product;
                    const userMessage = `Tell me more about ${productName}`;
                    
                    // 1. Add user message to chat
                    addMessageToChat('user', userMessage);
                    chatHistory.push({ role: 'user', parts: [{ text: userMessage }] });
                    setLoading(true);

                    // 2. Create prompt for Gemini
                    const langName = i18n[selectedLanguage].sidebarTitle || 'English';
                    const prompt = `Act as a simple financial explainer for a beginner in India. A user wants to know more about "${productName}". 
                    Explain what it is, who it is good for, and the main risk, all in 2-3 simple bullet points. 
                    Respond ONLY in the ${langName} language. Keep the explanation under 60 words.`;

                    try {
                        // 3. Call Gemini for advice
                        const advice = await callGeminiForAdvice(prompt);
                        
                        // 4. Add bot response to chat
                        addMessageToChat('bot', advice);
                        chatHistory.push({ role: 'model', parts: [{ text: advice }] });
                        saveUserSession();

                    } catch (error) {
                        console.error("Learn More AI Error:", error);
                        showError("Sorry, I couldn't get more details at this time.");
                        // Remove the failed user message from history
                        chatHistory.pop(); 
                    } finally {
                        setLoading(false);
                    }
                });
            }

            // Retry JSON button
            const retryBtn = parentElement.querySelector('#retry-json-btn');
            if (retryBtn) {
                retryBtn.addEventListener('click', () => {
                    handleChatSubmit(null, true); // isRetry = true
                });
            }
        }

        // Session Management
        function saveUserSession() {
            const sessionData = {
                chatHistory: chatHistory.slice(-10),
                userProfile: userProfileData,
                language: selectedLanguage,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('finhelp_session', JSON.stringify(sessionData));
        }

        function loadUserSession() {
            const saved = localStorage.getItem('finhelp_session');
            if (saved) {
                const session = JSON.parse(saved);
                const savedDate = new Date(session.timestamp);
                const today = new Date();
                const hoursDiff = Math.abs(today - savedDate) / 36e5;
                if (hoursDiff < 24) {
                    showContinueSessionPrompt(session);
                } else {
                    localStorage.removeItem('finhelp_session');
                }
            }
        }

        function showContinueSessionPrompt(session) {
            sessionPrompt.classList.remove('hidden');
            sessionYes.onclick = () => {
                selectedLanguage = session.language || 'en';
                chatHistory = session.chatHistory || [];
                userProfileData = session.userProfile || { risk: null, goals: [], progress: [] };
                
                resetChat(false);
                updateLangButtons(selectedLanguage);
                updateUIText(selectedLanguage); // Update UI text on restore
                
                chatHistory.forEach(msg => {
                    const { token, jsonString, text } = processBotResponse(msg.parts[0].text);
                    let cardHTML = null;
                    
                    if (jsonString) {
                        try {
                            const products = parseProductJSON(jsonString);
                            cardHTML = products.map(createProductCard).join('');
                        } catch (e) {
                            // Ignore JSON errors during restore
                        }
                    }

                    const sender = msg.role === 'user' ? 'user' : 'bot';
                    
                    if (cardHTML) {
                        if (text) addMessageToChat(sender, text);
                        addMessageToChat(sender, cardHTML, true);
                    } else if (text) {
                        addMessageToChat(sender, text);
                    }
                });
                
                renderUIFromState();
                sessionPrompt.classList.add('hidden');
            };
            
            sessionNo.onclick = () => {
                localStorage.removeItem('finhelp_session');
                sessionPrompt.classList.add('hidden');
                resetChat(true);
            };
        }

        // RE-ADDED: Calculator Functions
        
        // Helper to format to Indian Rupees
        function formatCurrency(num) {
            // FIX: Round the number first to avoid floating point artifacts
            const roundedNum = Math.round(num);

            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            }).format(roundedNum); // Use roundedNum
        }

        function calculateSIP(e) {
            e.preventDefault();
            const investment = parseFloat(document.getElementById('sip-investment').value);
            const rateInput = parseFloat(document.getElementById('sip-rate').value);
            const years = parseFloat(document.getElementById('sip-years').value);
            
            const rate = rateInput / 100 / 12; // Monthly rate
            const months = years * 12;

            const futureValue = investment * (((Math.pow(1 + rate, months) - 1) / rate) * (1 + rate));
            const totalInvested = investment * months;
            const totalGains = futureValue - totalInvested;

            const resultEl = document.getElementById('sip-result');
            const langData = i18n[selectedLanguage].calculator.sip;

            // NEW: Store inputs for AI analysis
            const inputs = {
                investment,
                rate: rateInput,
                years,
                futureValue,
                totalInvested
            };

            resultEl.innerHTML = `
                <p>${langData.resultTitle}</p>
                <h4>${formatCurrency(futureValue)}</h4>
                <div class="flex justify-between text-sm mt-3 border-t pt-3">
                    <span class="text-gray-600">${langData.invested}:</span>
                    <span class="font-medium">${formatCurrency(totalInvested)}</span>
                </div>
                <div class="flex justify-between text-sm mt-1">
                    <span class="text-gray-600">${langData.gains}:</span>
                    <span class="font-medium text-green-600">${formatCurrency(totalGains)}</span>
                </div>
                <!-- NEW: AI Analysis Button -->
                <div class="ai-analysis-container mt-4 border-t pt-4">
                    <button type="button" class="analyze-btn w-full px-4 py-2 bg-blue-50 text-blue-700 rounded-lg font-semibold hover:bg-blue-100 transition-colors" data-tool="sip" data-inputs='${JSON.stringify(inputs)}'>
                        ‚ú® <span data-i18n="calculator.analyze">Analyze My Results</span>
                    </button>
                    <div class="ai-advice-content mt-3 text-sm text-gray-700 p-3 bg-gray-50 rounded-lg hidden"></div>
                </div>
            `;
            resultEl.classList.remove('hidden');
        }

        function calculateEMI(e) {
            e.preventDefault();
            const p = parseFloat(document.getElementById('emi-amount').value);
            const rateInput = parseFloat(document.getElementById('emi-rate').value);
            const n = parseFloat(document.getElementById('emi-months').value);

            const r = rateInput / 100 / 12; // Monthly rate
            const emi = p * r * (Math.pow(1 + r, n) / (Math.pow(1 + r, n) - 1));
            const totalPayment = emi * n;
            const totalInterest = totalPayment - p;

            const resultEl = document.getElementById('emi-result');
            const langData = i18n[selectedLanguage].calculator.emi;

            // NEW: Store inputs for AI analysis
            const inputs = {
                loanAmount: p,
                rate: rateInput,
                months: n,
                emi,
                totalInterest
            };

            resultEl.innerHTML = `
                <p>${langData.resultTitle}</p>
                <h4>${formatCurrency(emi)}</h4>
                <div class="flex justify-between text-sm mt-3 border-t pt-3">
                    <span class="text-gray-600">${langData.interest}:</span>
                    <span class="font-medium">${formatCurrency(totalInterest)}</span>
                </div>
                <div class="flex justify-between text-sm mt-1">
                    <span class="text-gray-600">${langData.total}:</span>
                    <span class="font-medium">${formatCurrency(totalPayment)}</span>
                </div>
                <!-- NEW: AI Analysis Button -->
                <div class="ai-analysis-container mt-4 border-t pt-4">
                    <button type="button" class="analyze-btn w-full px-4 py-2 bg-blue-50 text-blue-700 rounded-lg font-semibold hover:bg-blue-100 transition-colors" data-tool="emi" data-inputs='${JSON.stringify(inputs)}'>
                        ‚ú® <span data-i18n="calculator.analyze">Analyze My Results</span>
                    </button>
                    <div class="ai-advice-content mt-3 text-sm text-gray-700 p-3 bg-gray-50 rounded-lg hidden"></div>
                </div>
            `;
            resultEl.classList.remove('hidden');
        }

        function calculateFD(e) {
            e.preventDefault();
            const p = parseFloat(document.getElementById('fd-amount').value);
            const rateInput = parseFloat(document.getElementById('fd-rate').value);
            const t = parseFloat(document.getElementById('fd-years').value);

            const r = rateInput / 100;
            // Assuming quarterly compounding, n=4
            const n = 4;
            const maturityValue = p * Math.pow((1 + r / n), n * t);
            const totalGains = maturityValue - p;

            const resultEl = document.getElementById('fd-result');
            const langData = i18n[selectedLanguage].calculator.fd;

            // NEW: Store inputs for AI analysis
            const inputs = {
                investment: p,
                rate: rateInput,
                years: t,
                maturityValue
            };

            resultEl.innerHTML = `
                <p>${langData.resultTitle}</p>
                <h4>${formatCurrency(maturityValue)}</h4>
                <div class="flex justify-between text-sm mt-3 border-t pt-3">
                    <span class="text-gray-600">${langData.invested}:</span>
                    <span class="font-medium">${formatCurrency(p)}</span>
                </div>
                <div class="flex justify-between text-sm mt-1">
                    <span class="text-gray-600">${langData.gains}:</span>
                    <span class="font-medium text-green-600">${formatCurrency(totalGains)}</span>
                </div>
                <!-- NEW: AI Analysis Button -->
                <div class="ai-analysis-container mt-4 border-t pt-4">
                    <button type="button" class="analyze-btn w-full px-4 py-2 bg-blue-50 text-blue-700 rounded-lg font-semibold hover:bg-blue-100 transition-colors" data-tool="fd" data-inputs='${JSON.stringify(inputs)}'>
                        ‚ú® <span data-i18n="calculator.analyze">Analyze My Results</span>
                    </button>
                    <div class="ai-advice-content mt-3 text-sm text-gray-700 p-3 bg-gray-50 rounded-lg hidden"></div>
                </div>
            `;
            resultEl.classList.remove('hidden');
        }

        function calculateGoal(e) {
            e.preventDefault();
            const target = parseFloat(document.getElementById('goal-target').value);
            const years = parseFloat(document.getElementById('goal-years').value);
            const rateInput = parseFloat(document.getElementById('goal-rate').value);
            
            const rate = rateInput / 100 / 12; // Monthly rate
            const months = years * 12;

            const monthlySIP = (target * rate) / ((Math.pow(1 + rate, months) - 1) * (1 + rate));

            const resultEl = document.getElementById('goal-result');
            const langData = i18n[selectedLanguage].calculator.goal;

            // NEW: Store inputs for AI analysis
            const inputs = {
                target,
                years,
                rate: rateInput,
                monthlySIP
            };

            resultEl.innerHTML = `
                <p>${langData.resultTitle}</p>
                <h4>${formatCurrency(monthlySIP)}</h4>
                <!-- NEW: AI Analysis Button -->
                <div class="ai-analysis-container mt-4 border-t pt-4">
                    <button type="button" class="analyze-btn w-full px-4 py-2 bg-blue-50 text-blue-700 rounded-lg font-semibold hover:bg-blue-100 transition-colors" data-tool="goal" data-inputs='${JSON.stringify(inputs)}'>
                        ‚ú® <span data-i18n="calculator.analyze">Analyze My Results</span>
                    </button>
                    <div class="ai-advice-content mt-3 text-sm text-gray-700 p-3 bg-gray-50 rounded-lg hidden"></div>
                </div>
            `;
            resultEl.classList.remove('hidden');
        }

        // RE-ADDED: Handle AI analysis button click
        async function getCalculatorAdvice(button) {
            const tool = button.dataset.tool;
            const inputs = JSON.parse(button.dataset.inputs);
            const langName = i18n[selectedLanguage].sidebarTitle || 'English';
            let prompt = '';

            // Disable button
            button.disabled = true;
            button.innerHTML = `‚ú® <span data-i18n="calculator.analyzing">${i18n[selectedLanguage].calculator.analyzing || 'Analyzing...'}</span>`;

            // Create a specific prompt for each tool
            switch (tool) {
                case 'sip':
                    prompt = `Act as a friendly financial advisor for a beginner in India. A user calculated that investing ${formatCurrency(inputs.investment)}/month for ${inputs.years} years at ${inputs.rate}% will give them ${formatCurrency(inputs.futureValue)}. 
                    Give one short (1-2 sentence) piece of encouraging advice based on this. Is this a good way to build wealth?
                    Respond ONLY in the ${langName} language. Keep it under 50 words.`;
                    break;
                case 'emi':
                    prompt = `Act as a friendly financial advisor for a beginner in India. A user is taking a loan of ${formatCurrency(inputs.loanAmount)} for ${inputs.months} months at ${inputs.rate}%. Their EMI is ${formatCurrency(inputs.emi)} and they will pay ${formatCurrency(inputs.totalInterest)} in interest.
                    Give one short (1-2 sentence) piece of simple advice about this EMI or interest. 
                    Respond ONLY in the ${langName} language. Keep it under 50 words.`;
                    break;
                case 'fd':
                    prompt = `Act as a friendly financial advisor for a beginner in India. A user is investing ${formatCurrency(inputs.investment)} in an FD for ${inputs.years} years at ${inputs.rate}% and will get ${formatCurrency(inputs.maturityValue)}.
                    Give one short (1-2 sentence) piece of simple advice about this FD investment. Is it good for safety or growth?
                    Respond ONLY in the ${langName} language. Keep it under 50 words.`;
                    break;
                case 'goal':
                    prompt = `Act as a friendly financial advisor for a beginner in India. A user needs to invest ${formatCurrency(inputs.monthlySIP)}/month for ${inputs.years} years at ${inputs.rate}% to reach their goal of ${formatCurrency(inputs.target)}.
                    Give one short (1-2 sentence) piece of encouraging advice about this monthly investment. Is this goal achievable?
                    Respond ONLY in the ${langName} language. Keep it under 50 words.`;
                    break;
            }

            try {
                const advice = await callGeminiForAdvice(prompt);
                const adviceContainer = button.nextElementSibling; // The .ai-advice-content div
                adviceContainer.innerHTML = advice.replace(/\n/g, '<br>');
                adviceContainer.classList.remove('hidden');
                button.classList.add('hidden'); // Hide the button after success
            } catch (error) {
                console.error("Calculator AI Error:", error);
                const adviceContainer = button.nextElementSibling;
                adviceContainer.innerHTML = "Sorry, I couldn't generate advice. Please try again.";
                adviceContainer.classList.remove('hidden');
                button.disabled = false; // Re-enable button on failure
                button.innerHTML = `‚ú® <span data-i18n="calculator.analyze">${i18n[selectedLanguage].calculator.analyze || 'Analyze My Results'}</span>`;
            }
        }


        // RE-ADDED: Modal Control Functions
        function openModal(toolType) {
            closeModal(); // UPDATED per instruction 4

            const template = document.getElementById(`${toolType}-calc-template`);
            if (!template) {
                console.error(`Calculator template not found: ${toolType}-calc-template`);
                return;
            }

            // Set modal title from i18n
            calculatorModalTitle.textContent = i18n[selectedLanguage].calculator[toolType].title;

            // Get HTML content from the script template and inject it
            calculatorModalBody.innerHTML = template.innerHTML;

            // Translate the new content in the modal
            updateUIText(selectedLanguage, calculatorModalBody); // Pass modal body as element

            // Add the correct form listener
            const form = calculatorModalBody.querySelector('form'); // Get form
            if (toolType === 'sip' && form) { // Add form check
                form.addEventListener('submit', calculateSIP);
            } else if (toolType === 'emi' && form) {
                form.addEventListener('submit', calculateEMI);
            } else if (toolType === 'fd' && form) {
                form.addEventListener('submit', calculateFD);
            } else if (toolType === 'goal' && form) {
                form.addEventListener('submit', calculateGoal);
            }

            // Show modal
            calculatorModal.classList.remove('hidden');
            calculatorModal.classList.add('flex');
            
            // UPDATED: Reset position based on new CSS and transform logic
            calculatorModalContent.style.top = '100px';
            calculatorModalContent.style.left = '100px';
            calculatorModalContent.style.transform = 'translate3d(0, 0, 0)'; 
        }

        function closeModal() {
            calculatorModal.classList.add('hidden');
            calculatorModal.classList.remove('flex');
            calculatorModalBody.innerHTML = ''; // Clear content
        }

        // UPDATED: Function to make modal draggable per instruction 2
        function makeDraggable(modal, header) {
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;

            header.addEventListener("mousedown", dragStart);
            document.addEventListener("mousemove", drag);
            document.addEventListener("mouseup", dragEnd);

            function dragStart(e) {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
                
                // Fixed: Check if target is header or a child of header
                if (e.target === header || header.contains(e.target)) {
                    isDragging = true;
                }
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    
                    xOffset = currentX;
                    yOffset = currentY;
                    
                    setTranslate(currentX, currentY, modal);
                }
            }

            function dragEnd(e) {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
            }

            function setTranslate(xPos, yPos, el) {
                // Fixed typo from user instruction (was '...px, 0)')
                el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`;
            }
        }


        // Event Listeners
        function handleLanguageSelect(e) {
            const button = e.target.closest('.lang-btn');
            if (!button) return;

            speechSynthesis.cancel();
            selectedLanguage = button.dataset.lang;
            // REMOVED: localStorage.setItem('finhelp_language', selectedLanguage);
            updateLangButtons(selectedLanguage);
            updateUIText(selectedLanguage); // NEW: Update all static text
            resetChat();
        }

        // Initialization
        function init() {
            langSelector.addEventListener('click', handleLanguageSelect);
            chatForm.addEventListener('submit', handleChatSubmit);
            micButton.addEventListener('click', toggleRecording);
            chatMessageList.addEventListener('click', handleSpeakButtonClick);

            // RE-ADDED: Calculator Listeners
            toolsSection.addEventListener('click', (e) => {
                const toolBtn = e.target.closest('.tool-btn');
                if (toolBtn) {
                    openModal(toolBtn.dataset.tool);
                }
            });
            calculatorModalClose.addEventListener('click', closeModal);
            calculatorModal.addEventListener('click', (e) => {
                // Close if clicking on backdrop
                if (e.target === calculatorModal) {
                    closeModal();
                }
            });
            // NEW: Listener for dynamic AI buttons in modal
            calculatorModalBody.addEventListener('click', (e) => {
                const analyzeBtn = e.target.closest('.analyze-btn');
                if (analyzeBtn) {
                    getCalculatorAdvice(analyzeBtn);
                }
            });

            // NEW: Make the calculator draggable
            makeDraggable(calculatorModalContent, document.getElementById('calculator-modal-header'));


            // REMOVED: localStorage.setItem('finhelp_language', selectedLanguage);

            updateLangButtons(selectedLanguage);
            updateUIText(selectedLanguage); // NEW: Initial text update
            loadVoices();
            setupSpeechRecognition();
            loadUserSession();

            if (!localStorage.getItem('finhelp_session')) {
                const initialWelcome = i18n[selectedLanguage].welcomeMsg;
                addMessageToChat('bot', initialWelcome); // FIX: Changed welcomeText to initialWelcome
                chatHistory.push({ role: 'model', parts: [{ text: initialWelcome }] });
            }
        }

        // Start the application
        init();
    </script>
</body>
</html>


